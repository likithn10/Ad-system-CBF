<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Blood Bank System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      margin: 0;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 22px;
      background: #007BFF;
      color: white;
    }
    .hamburger {
      font-size: 1.4rem;
      cursor: pointer;
      background: none;
      border: none;
      color: white;
    }
    .main-container {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 360px;
      gap: 20px;                                   
      margin: 20px;
      align-items: start;
    }

    .greeting-text { padding: 5px; color: #333; }
    .greeting-text h3 {
      color: #007BFF;
      margin-bottom: 5px;
      font-size: 1.6rem;
      font-weight: 700;
    }
    .greeting-text p { margin-bottom: 10px; font-size: 1rem; font-weight: 600; }

    .embed-wrap {
      width: 100%;
      height: 120vh;               /* Taller iframe as you asked */
      border: 2px solid #ccc;
      border-radius: 10px;
      overflow: hidden;           /* No internal iframe scroll bar */
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      background: #fff;
    }
    .embed-wrap iframe { width: 100%; height: 100%; border: none; }

    /* Info block below iframe (plain text, no box) */
    .info-block {
      margin-top: 24px;
      padding: 0;                 /* no inner padding box look */
      background: transparent;    /* no background box */
      border: none;               /* no border */
      box-shadow: none;           /* no shadow */
      color: #444;
    }
    .info-block h4,
    .info-block h5 { margin-top: 18px; }
    .info-block ul { margin: 8px 0 0 20px; line-height: 1.7; }
    .info-sep { margin: 18px 0; border: 0; height: 1px; background: #e7e7e7; }
.info-block .section-spacing {
  margin-bottom: 250px;   /* Adjust height of gap here */
}

    /* Ads */
    .ads-container { display: flex; flex-direction: column; gap: 14px; }
    .ad-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      padding: 12px;
      transition: transform 0.28s ease, box-shadow 0.28s ease;
    }
    .ad-card:hover { transform: translateY(-4px); box-shadow: 0 8px 24px rgba(0,0,0,0.12); }
    .ad-card img {
      width: 100%;
      height: 160px;              /* Slightly smaller ad image */
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .ad-card h3 { margin: 6px 0 4px; font-size: 1.05rem; }
    .ad-card p.category { color: #666; margin: 0 0 6px; font-size: 0.9rem; }
    .ad-card small.ctr { color: #999; display: block; margin-bottom: 8px; font-size: 0.85rem; }
    .ad-actions { display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .icon-btn { background:none; border:none; font-size:1.1rem; cursor:pointer; padding:6px; }
    .icon-btn:hover { transform:scale(1.12); }
    .btn-learn { background:#007BFF; color:#fff; padding:6px 12px; border-radius:8px; border:none; font-size: 0.9rem; }
    .btn-learn:hover { background:#0056b3; color:#fff; }

    /* Popup Menu */
    #menu {
      display:none;
      position:absolute;
      right:20px;
      top:60px;
      background:white;
      box-shadow:0 6px 20px rgba(0,0,0,0.15);
      border-radius:8px;
      padding:10px;
      z-index:2000;
    }

    /* Full-width footer (not boxed) */
    .site-footer {
      margin-top: 24px;
      padding: 18px 22px;
      background: #ffffff;        /* clean full-width footer */
      border-top: 1px solid #e9e9e9;
      color: #555;
    }
    .site-footer a { text-decoration: none; }

    @media (max-width: 1100px){
      .main-container { grid-template-columns: 1fr; margin: 12px; }
    }
  </style>
</head>
<body>

  <!-- Top bar -->
  <div class="top-bar">
    <div style="font-weight:600">Blood Bank System</div>
    <div class="d-flex align-items-center gap-2">
      <a class="btn btn-light btn-sm" href="{{ url_for('publish') }}">Publish</a>
      <a class="btn btn-outline-light btn-sm" href="{{ url_for('my_ads') }}">My Ads</a>
      <button class="hamburger" onclick="toggleMenu()">‚ò∞</button>
    </div>
  </div>

  <!-- Popup Menu -->
  <div id="menu">
    <a href="{{ url_for('profile') }}" class="btn btn-outline-secondary w-100">Profile</a>
    <a href="mailto:likithn10@gmail.com" class="btn btn-outline-primary w-100">Contact Us</a>
    <a href="/logout" class="btn btn-danger w-100">Logout</a>
  </div>

  <!-- Main container (LEFT = Blood Bank + Info, RIGHT = Ads) -->
  <div class="main-container">

    <!-- LEFT SIDE -->
    <div>
      <!-- Greeting (kept small) -->
      <div class="greeting-text">
        <h3>Hello, {{ session.get('user')['username'] }} üëã</h3>
        <p>Welcome to <span style="color:#FF5733;">Blood Bank System</span> üéØ</p>
      </div>

      <!-- Single IFRAME (responsive, taller) -->
      <div class="embed-wrap">
        <iframe src="https://bloodbank-cloud-1.onrender.com/"></iframe>
      </div>

      <!-- ===== Information Section (plain text, no box) ===== -->
      <div class="info-block">
        <h4 style="color:#d9534f; font-weight:700;">üíâ Why Donate Blood?</h4>
        <p>
          Every 2 seconds, someone needs blood. A single donation can save up to
          <b>three lives</b>. Donating blood is safe, simple and it makes a huge difference
          for people who have accidents, surgeries, cancer treatments, etc.
        </p>

        <h5 style="font-weight:600;">ü©∏ Who Can Donate?</h5>
        <ul>
          <li>Age between <b>18 and 65</b></li>
          <li>Weight above <b>50 kg</b></li>
          <li>No major illness or surgery in the past 6 months</li>
          <li>Hemoglobin level above <b>12.5 g/dL</b></li>
        </ul>

        <div class="section-spacing">
        <h5 style="font-weight:600;">‚ù§Ô∏è Your Donation Can Save Lives</h5>
        <p>
          ‚ÄúThe blood you donate gives someone another chance at life.‚Äù Join the mission. Be a hero. Save lives.
        </p>
        </div>

        <h5 style="font-weight:700;">About This Website</h5>
        <p style="margin-bottom: 10px;">
          This platform integrates a <b>Smart Ad Recommendation System</b> with an
          <b>Online Blood Bank System</b>. The left panel embeds the blood bank
          application for quick access, while the right panel shows personalized,
          privacy-respecting ads.
        </p>

        <h5 style="font-weight:700;">Our Mission</h5>
        <p style="margin-bottom: 10px;">
          To make blood availability faster and more transparent while supporting the
          platform through relevant, high-quality advertisements.
        </p>

        <h5 style="font-weight:700;">FAQs</h5>
        <ul>
          <li>How do I register as a donor? <br>-> Just go to add donors and fill the required details ,if required the people in need will contact you.</li>
          <li>How is donor data protected? <br>-> Donor data is protected from fake bots and robots who scrape the websites ,the data is only available for real users.<br>That's the reason login is given for register.</li>
          <li>How are ads selected? <br>-> Ads are published by persons who are users of this website.Here you can publish your own ads<br> Your ads recomendation work on your interests ,so if you dont like the add by disliking it you can get new ads and old ads will not be shown again.</li>
        </ul>

        <h5 style="font-weight:700;">Policies</h5>
        <ul>
          <li><a href="#" onclick="openPolicyPopup('terms', event)">Terms & Conditions</a></li>
          <li><a href="#" onclick="openPolicyPopup('privacy', event)">Privacy Policy</a></li>
          <li><a href="#" onclick="openPolicyPopup('refund', event)">Refund & Cancellation</a></li>
        </ul>

        <h5 style="font-weight:700;">Connect With Us</h5>
        <ul>
          <li>Phone: 7795180130, 8277023553</li>
          <li>Email: <a href="mailto:likithn10@gmail.com">likithn10@gmail.com</a></li>
          <li>Instagram: <a href="https://www.instagram.com/likith_.46/" target="_blank" rel="noopener noreferrer">@likith_.46</a>
</li>
        </ul>
      </div>
    </div>

    <!-- RIGHT SIDE (Ads Section ‚Äì stays full, unaffected by left) -->
    <div class="ads-container" id="adsContainer">
      <p>Loading ads...</p>
    </div>

  </div> 

  <!-- Full-width footer (under both columns, no box) -->
  <footer class="site-footer">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start gap-2">
      <div><strong>Blood Bank System</strong> ‚Ä¢ Smart Ad Recommender</div>
      <div>&copy; <span id="yr"></span> All rights reserved.</div>
      <div>
        <a href="mailto:likithn10@gmail.com">Contact</a>
      </div>
    </div>
  </footer>

  <!-- Modal for Ad Details -->
  <div class="modal fade" id="adModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="adModalLabel">Ad Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="adModalBody">Loading...</div>
        <div class="modal-footer">
          <a id="adModalLink" class="btn btn-primary" href="#" target="_blank" rel="noopener noreferrer">Go to offer</a>
        </div>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  let allAds = [];
  let visibleAds = [];
  let hiddenAds = [];

  function toggleMenu(){
    const m = document.getElementById('menu');
    m.style.display = (m.style.display === 'block') ? 'none' : 'block';
  }

  function dedupeAds(ads){
    const map = new Map();
    ads.forEach(ad => {
      const key = (ad.title || '').trim().toLowerCase() || ('id-'+ad.id);
      if(!map.has(key) || ad.ctr > map.get(key).ctr) map.set(key, ad);
    });
    return Array.from(map.values());
  }

  async function loadAds(){
    const container = document.getElementById('adsContainer');
    container.innerHTML = '<p>Loading ads...</p>';
    try{
      const res = await fetch('/get_ads');
      allAds = await res.json();
      allAds = dedupeAds(allAds);

      // Ads add and delete //
      visibleAds = allAds.slice(0, 7);
      hiddenAds  = allAds.slice(6);

      renderAds();
    }catch(e){
      console.error(e);
      container.innerHTML = '<p>Error loading ads.</p>';
    }
  }

  function renderAds(){
    const container = document.getElementById('adsContainer');
    container.innerHTML = '';
    if(visibleAds.length === 0){
      container.innerHTML = '<p>No ads available right now.</p>';
      return;
    }
    visibleAds.forEach(ad => {
      const card = document.createElement('div');
      card.className = 'ad-card';
      const url = ad.link || ad.url || ad.target_page || '';
      const ctrPercent = (ad.ctr * 100).toFixed(2);
      const score = Number(ad.score ?? 0).toFixed(2);

      card.innerHTML = `
        <img src="${ad.image_url}" alt="${ad.title}">
        <h3>${ad.title}</h3>
        <p class="category">${ad.category}</p>
        <small class="ctr">CTR: ${ctrPercent}% ‚Ä¢ Score: ${score}</small>
        <div class="ad-actions">
          <div>
            <button type="button" class="icon-btn" title="Like" onclick="likeAd(event, ${ad.id})">üëç</button>
            <button type="button" class="icon-btn" title="Dislike" onclick="dislikeAd(event, ${ad.id})">üëé</button>
          </div>
          <div>
            <button type="button" class="btn-learn"
              onclick="viewAd(event, '${escapeForJS(ad.title)}', \`${escapeBackticks(ad.details)}\`, ${ad.id}, '${escapeForJS(url)}')">
              Learn More
            </button>
          </div>
        </div>
      `;
      container.appendChild(card);
    });
  }

  function escapeBackticks(s){
    return (s || '').replace(/`/g, "\\`");
  }
  function escapeForJS(s){ return (s||'').replace(/'/g,"\\'").replace(/"/g,'\\"'); }

  function likeAd(ev, adId){
    ev.preventDefault();
    fetch(`/like/${adId}`, { method: 'POST' })
      .then(() => loadAds())
      .catch(console.error);
  }

  function dislikeAd(ev, adId){
    ev.preventDefault();
    fetch(`/dislike/${adId}`, { method: 'POST' })
      .then(() => loadAds())
      .catch(console.error);
  }

  function viewAd(ev, title, details, adId, url){
    ev.preventDefault();
    document.getElementById('adModalLabel').innerText = title || 'Ad Details';
    document.getElementById('adModalBody').innerText = details || 'No details available.';
    const linkEl = document.getElementById('adModalLink');
    if (url && url.trim()) {
      const safeUrl = /^https?:\/\//i.test(url) ? url : `https://${url}`;
      linkEl.href = safeUrl;
      linkEl.style.display = 'inline-block';
    } else {
      linkEl.style.display = 'none';
    }
    const modal = new bootstrap.Modal(document.getElementById('adModal'));
    modal.show();
    fetch(`/click/${adId}`, { method: 'POST' }).catch(console.error);
  }

  // Footer year
  document.getElementById('yr').textContent = new Date().getFullYear();

  loadAds();


function openPolicyPopup(type, event) {
  if (event) event.preventDefault(); // ‚úÖ Stops scroll-to-top

  const overlay = document.getElementById('policyOverlay');
  const title = document.getElementById('policyTitle');
  const text = document.getElementById('policyText');

  if (type === 'terms') {
    title.textContent = "Terms & Conditions";
    text.innerHTML = `
      <strong>1. Acceptance of Terms</strong><br>
      By accessing or using this website, you agree to these Terms and Conditions.<br><br>

      <strong>2. User Responsibilities</strong><br>
      ‚Ä¢ Users must provide accurate information while registering or publishing ads.<br>
      ‚Ä¢ Misuse of platform features, spamming or posting inappropriate ads is strictly prohibited.<br><br>

      <strong>3. Blood Donations</strong><br>
      ‚Ä¢ We act only as a platform for connecting donors and receivers.<br>
      ‚Ä¢ We are not responsible for medical mishaps or misuse of donor data.<br><br>

      <strong>4. Ad Publishing</strong><br>
      ‚Ä¢ Ads must be legal and must not contain abusive, misleading, or harmful content.<br>
      ‚Ä¢ Admin reserves the right to remove any advertisement without prior notice.<br><br>

      <strong>5. Limitation of Liability</strong><br>
      ‚Ä¢ This platform is not responsible for any financial, medical, or personal losses resulting from its usage.<br><br>
    `;
  }
  else if (type === 'privacy') {
    title.textContent = "Privacy Policy";
    text.innerHTML = `
      <strong>1. Data Collection</strong><br>
      ‚Ä¢ We collect username, email, contact number and ad details for account creation and service usage.<br><br>

      <strong>2. Data Usage</strong><br>
      ‚Ä¢ Data is used for donor identification, ad personalization and user verification only.<br><br>

      <strong>3. Data Protection</strong><br>
      ‚Ä¢ Passwords are encrypted.<br>
      ‚Ä¢ Personal contact details are shown only to logged-in verified users.<br><br>

      <strong>4. Third Party Sharing</strong><br>
      ‚Ä¢ We do not sell or share personal data with third parties.<br><br>
    `;
  }
  else if (type === 'refund') {
    title.textContent = "Refund & Cancellation Policy";
    text.innerHTML = `
      <strong>1. Donation Policy</strong><br>
      ‚Ä¢ This platform is free to use; we do not charge users for blood donation services.<br><br>

      <strong>2. Advertisement Refund</strong><br>
      ‚Ä¢ If in future paid ads are introduced, users may request refunds only in cases of technical failure.<br><br>

      <strong>3. Cancellation</strong><br>
      ‚Ä¢ Users can delete their ads anytime from the "My Ads" section.<br>
      ‚Ä¢ User accounts can be deactivated upon request via email.<br><br>
    `;
  }

  overlay.style.display = "flex";
}

function closePolicyPopup() {
  document.getElementById('policyOverlay').style.display = "none";
}
</script>
<!-- Policy Popup -->
<div id="policyOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#fff; padding:20px; border-radius:10px; max-width:600px; width:90%; position:relative;">
    <span onclick="closePolicyPopup()" style="position:absolute; top:10px; right:15px; cursor:pointer; font-weight:bold;">&times;</span>
    <h4 id="policyTitle">Policy</h4>
    <p id="policyText">Loading...</p>
  </div>
</div>
</body>
</html>
